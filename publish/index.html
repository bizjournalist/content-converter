<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Converter</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');
        
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --secondary: #64748b;
            --success: #059669;
            --background: #f8fafc;
            --card-bg: #ffffff;
            --text: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --border-hover: #cbd5e1;
            --focus: #3b82f6;
            --surface: #f1f5f9;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            line-height: 1.6;
            color: var(--text);
            background: var(--background);
            min-height: 100vh;
            padding: 2rem;
        }
        
        header {
            text-align: center;
            margin-bottom: 3rem;
            animation: fadeIn 0.6s ease-out;
        }
        
        h1 {
            font-size: 2rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.5rem;
            letter-spacing: -0.025em;
        }
        
        header p {
            font-size: 1rem;
            color: var(--text-muted);
            font-weight: 400;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .progress-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 2rem;
            gap: 0.5rem;
        }
        
        .progress-step {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text-muted);
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .progress-step.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .progress-step.completed {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }
        
        .step-number {
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .progress-step:not(.active):not(.completed) .step-number {
            background: var(--surface);
            color: var(--text-muted);
        }
        
        .card {
            background: var(--card-bg);
            border-radius: 0.75rem;
            box-shadow: var(--shadow);
            padding: 2rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border);
            animation: slideUp 0.5s ease-out;
        }
        
        .card h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text);
        }
        
        .upload-area {
            border: 2px dashed var(--border);
            padding: 3rem 2rem;
            text-align: center;
            border-radius: 0.75rem;
            transition: all 0.2s ease;
            background: var(--surface);
        }
        
        .upload-area:hover, .upload-area.dragover {
            border-color: var(--primary);
            background: #eff6ff;
        }
        
        .upload-area p {
            margin-bottom: 1rem;
            font-size: 1rem;
            font-weight: 500;
            color: var(--text);
        }
        
        .upload-area .sub-text {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-bottom: 1.5rem;
        }
        
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }
        
        .btn:disabled {
            background: var(--secondary);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.6;
        }
        
        .btn-secondary {
            background: var(--secondary);
        }
        
        .btn-secondary:hover {
            background: #475569;
        }
        
        .btn-outline {
            background: transparent;
            color: var(--secondary);
            border: 1px solid var(--border);
        }
        
        .btn-outline:hover {
            background: var(--surface);
            border-color: var(--border-hover);
        }
        
        input[type="file"] {
            display: none;
        }
        
        .detection-result {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 0.75rem;
            padding: 2rem;
            margin: 1.5rem 0;
            text-align: center;
            animation: slideUp 0.5s ease-out;
        }
        
        .detection-result h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--primary);
        }
        
        .detection-result p {
            font-size: 0.875rem;
            margin-bottom: 1.5rem;
            color: var(--text-muted);
            line-height: 1.6;
        }
        
        .workflow-area {
            margin-top: 1.5rem;
        }
        
        .hidden {
            display: none;
        }
        
        textarea {
            width: 100%;
            min-height: 150px;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            font-family: 'SF Mono', 'Monaco', 'Cascadia Code', monospace;
            font-size: 0.875rem;
            resize: vertical;
            margin-bottom: 1rem;
            transition: all 0.2s ease;
            background: var(--card-bg);
        }
        
        textarea:focus {
            border-color: var(--focus);
            box-shadow: 0 0 0 3px rgb(59 130 246 / 0.1);
            outline: none;
        }
        
        .column-list {
            margin: 1rem 0;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .column-badge {
            background: var(--surface);
            color: var(--text);
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid var(--border);
        }
        
        .column-badge:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: translateY(-1px);
        }
        
        .help-box {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
            font-size: 0.875rem;
            color: var(--text-muted);
        }
        
        .help-box strong {
            color: var(--text);
        }
        
        .help-box code {
            background: rgba(59, 130, 246, 0.1);
            color: var(--primary);
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-family: 'SF Mono', monospace;
            font-size: 0.8rem;
        }
        
        .preview-area {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 1rem 0;
            min-height: 200px;
            font-family: 'SF Mono', monospace;
            font-size: 0.875rem;
            white-space: pre-wrap;
            overflow-y: auto;
            max-height: 300px;
            line-height: 1.5;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.375rem;
            font-weight: 500;
            color: var(--text);
            font-size: 0.875rem;
        }
        
        .form-group input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 0.375rem;
            transition: all 0.2s ease;
            background: var(--card-bg);
            font-size: 0.875rem;
        }
        
        .form-group input:focus {
            border-color: var(--focus);
            box-shadow: 0 0 0 3px rgb(59 130 246 / 0.1);
            outline: none;
        }
        
        .table-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            background: var(--card-bg);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
            font-size: 0.875rem;
        }
        
        th {
            background: var(--surface);
            font-weight: 600;
            color: var(--text);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        tr:hover {
            background: #f8fafc;
        }
        
        .missing-data {
            background: #fef3c7;
        }
        
        .preview-info {
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }
        
        .preview-info strong {
            color: var(--text);
        }
        
        .button-group {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Mobile responsiveness */
        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }
            
            .card {
                padding: 1.5rem;
            }
            
            .upload-area {
                padding: 2rem 1rem;
            }
            
            .progress-bar {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .button-group {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Content Converter</h1>
        <p>A tool for converting content between CSV and text formats</p>
    </header>
    
    <div class="container">
        <!-- Progress Bar -->
        <div class="progress-bar" id="progressBar">
            <div class="progress-step active" id="step1">
                <div class="step-number">1</div>
                <span>Upload</span>
            </div>
            <div class="progress-step" id="step2">
                <div class="step-number">2</div>
                <span>Configure</span>
            </div>
            <div class="progress-step" id="step3">
                <div class="step-number">3</div>
                <span>Download</span>
            </div>
        </div>
        
        <!-- Initial Upload Area -->
        <div class="card" id="uploadCard">
            <div class="upload-area" id="uploadArea">
                <p>Drop your file here or click to browse</p>
                <p class="sub-text">Supports CSV and text files</p>
                <button class="btn" id="browseBtn">Choose File</button>
                <input type="file" id="fileInput" accept=".csv,.txt" />
            </div>
        </div>
        
        <!-- Detection Result -->
        <div class="detection-result hidden" id="detectionResult">
            <h3 id="detectionTitle"></h3>
            <p id="detectionMessage"></p>
            <div class="button-group">
                <button class="btn" id="continueBtn">Continue</button>
                <button class="btn-outline btn" id="restartBtn">Choose Different File</button>
            </div>
        </div>
        
        <!-- CSV to Text Workflow -->
        <div class="workflow-area hidden" id="csvToTextWorkflow">
            <div class="card">
                <h2>Create Text Format</h2>
                <p>Click any column name to add it to your template:</p>
                <div class="column-list" id="columnList"></div>
                <div class="help-box">
                    <strong>Template Guide:</strong> Use <code>{{ColumnName}}</code> to insert content. Add any text, spacing, or formatting as needed.
                </div>
                <label for="templateEditor">Text Format Template:</label>
                <textarea id="templateEditor" placeholder="Example:&#10;&#10;Name: {{Name}}&#10;Job: {{Job Title}}&#10;&#10;About: {{Tell us about yourself}}&#10;&#10;###"></textarea>
                <button class="btn" id="generateTextBtn">Generate Preview</button>
            </div>
            
            <div class="card">
                <h2>Preview & Download</h2>
                <div id="textPreview" class="preview-area">Your formatted text will appear here...</div>
                <button class="btn" id="downloadTextBtn" disabled>Download Text File</button>
            </div>
        </div>
        
        <!-- Text to CSV Workflow -->
        <div class="workflow-area hidden" id="textToCsvWorkflow">
            <div class="card">
                <h2>Configure Text Format</h2>
                <div class="form-group">
                    <label for="recordSeparator">Record separator</label>
                    <input type="text" id="recordSeparator" value="###" placeholder="e.g., ---, ###">
                </div>
                <div class="form-group">
                    <label for="fieldMarker">Field marker pattern</label>
                    <input type="text" id="fieldMarker" value="#FIELD#" placeholder="e.g., Name:, #FIELD#">
                </div>
                <div class="form-group">
                    <label for="fieldNames">Field names (one per line)</label>
                    <textarea id="fieldNames" rows="4" placeholder="Name&#10;Job Title&#10;Company&#10;About"></textarea>
                </div>
                <button class="btn" id="parseTextBtn">Generate CSV preview</button>
            </div>
            
            <div class="card">
                <h2>Preview & Download</h2>
                <div id="csvPreviewInfo" class="preview-info hidden"></div>
                <div class="table-container" style="display: none;" id="tableContainer">
                    <table id="csvPreviewTable">
                        <thead>
                            <tr id="csvTableHeader"></tr>
                        </thead>
                        <tbody id="csvTableBody"></tbody>
                    </table>
                </div>
                <div id="csvPreviewPlaceholder" class="preview-area">Your CSV data will appear here as a table...</div>
                <button class="btn" id="downloadCsvBtn" disabled>Download CSV File</button>
            </div>
        </div>
    </div>

    <script>
        var uploadArea = document.getElementById('uploadArea');
        var browseBtn = document.getElementById('browseBtn');
        var fileInput = document.getElementById('fileInput');
        var uploadCard = document.getElementById('uploadCard');
        var detectionResult = document.getElementById('detectionResult');
        var detectionTitle = document.getElementById('detectionTitle');
        var detectionMessage = document.getElementById('detectionMessage');
        var continueBtn = document.getElementById('continueBtn');
        var restartBtn = document.getElementById('restartBtn');
        var csvToTextWorkflow = document.getElementById('csvToTextWorkflow');
        var textToCsvWorkflow = document.getElementById('textToCsvWorkflow');
        
        var currentFile = null;
        var fileType = null;
        var csvData = null;
        var textContent = null;
        
        // Progress tracking
        function updateProgress(step) {
            var steps = ['step1', 'step2', 'step3'];
            steps.forEach(function(s, index) {
                var el = document.getElementById(s);
                el.classList.remove('active', 'completed');
                if (index < step - 1) {
                    el.classList.add('completed');
                } else if (index === step - 1) {
                    el.classList.add('active');
                }
            });
        }
        
        browseBtn.addEventListener('click', function() {
            fileInput.click();
        });
        
        fileInput.addEventListener('change', handleFileSelect);
        restartBtn.addEventListener('click', resetToStart);
        continueBtn.addEventListener('click', showWorkflow);
        
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                handleFileSelect(e);
            }
        });
        
        function handleFileSelect(event) {
            var file = event.target.files[0] || event.dataTransfer.files[0];
            if (!file) return;
            
            currentFile = file;
            var fileName = file.name.toLowerCase();
            
            if (fileName.endsWith('.csv') || file.type === 'text/csv') {
                fileType = 'csv';
                detectionTitle.textContent = 'CSV File Detected';
                detectionMessage.textContent = 'Found "' + file.name + '" with data. This will be converted to editable text format.';
                
                var reader = new FileReader();
                reader.onload = function(e) {
                    csvData = parseCSV(e.target.result);
                    setupCsvToTextWorkflow();
                };
                reader.readAsText(file);
                
            } else if (fileName.endsWith('.txt') || file.type === 'text/plain') {
                fileType = 'text';
                detectionTitle.textContent = 'Text File Detected';
                detectionMessage.textContent = 'Found "' + file.name + '" with formatted content. This will be converted to CSV format.';
                
                var reader = new FileReader();
                reader.onload = function(e) {
                    textContent = e.target.result;
                    setupTextToCsvWorkflow();
                };
                reader.readAsText(file);
                
            } else {
                alert('Please upload a CSV or TXT file.');
                return;
            }
            
            uploadCard.classList.add('hidden');
            detectionResult.classList.remove('hidden');
        }
        
        function resetToStart() {
            updateProgress(1);
            uploadCard.classList.remove('hidden');
            detectionResult.classList.add('hidden');
            csvToTextWorkflow.classList.add('hidden');
            textToCsvWorkflow.classList.add('hidden');
            fileInput.value = '';
            currentFile = null;
            fileType = null;
        }
        
        function showWorkflow() {
            updateProgress(2);
            detectionResult.classList.add('hidden');
            if (fileType === 'csv') {
                csvToTextWorkflow.classList.remove('hidden');
            } else {
                textToCsvWorkflow.classList.remove('hidden');
            }
        }
        
        function parseCSV(text) {
            var result = [];
            var headers = null;
            var currentRecord = [];
            var currentField = '';
            var inQuotes = false;
            
            for (var i = 0; i < text.length; i++) {
                var char = text[i];
                
                if (char === '"') {
                    if (i + 1 < text.length && text[i + 1] === '"') {
                        currentField += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    currentRecord.push(currentField.trim());
                    currentField = '';
                } else if ((char === '\n' || (char === '\r' && text[i + 1] !== '\n')) && !inQuotes) {
                    currentRecord.push(currentField.trim());
                    
                    if (!headers) {
                        headers = currentRecord;
                    } else {
                        var obj = {};
                        for (var j = 0; j < headers.length; j++) {
                            obj[headers[j]] = j < currentRecord.length ? currentRecord[j] : '';
                        }
                        result.push(obj);
                    }
                    
                    currentRecord = [];
                    currentField = '';
                } else if (char === '\r' && text[i + 1] === '\n' && !inQuotes) {
                    continue;
                } else {
                    currentField += char;
                }
            }
            
            if (currentField || currentRecord.length > 0) {
                currentRecord.push(currentField.trim());
                
                if (headers) {
                    var obj = {};
                    for (var j = 0; j < headers.length; j++) {
                        obj[headers[j]] = j < currentRecord.length ? currentRecord[j] : '';
                    }
                    result.push(obj);
                } else {
                    headers = currentRecord;
                }
            }
            
            return { headers: headers || [], data: result };
        }
        
        function setupCsvToTextWorkflow() {
            var columnList = document.getElementById('columnList');
            var templateEditor = document.getElementById('templateEditor');
            
            columnList.innerHTML = '';
            for (var i = 0; i < csvData.headers.length; i++) {
                var header = csvData.headers[i];
                var badge = document.createElement('div');
                badge.className = 'column-badge';
                badge.textContent = header;
                badge.onclick = (function(h) {
                    return function() { insertColumnIntoTemplate(h); };
                })(header);
                columnList.appendChild(badge);
            }
            
            populateDefaultTemplate(csvData.headers);
            
            var generateBtn = document.getElementById('generateTextBtn');
            generateBtn.onclick = generateTextFile;
        }
        
        function insertColumnIntoTemplate(columnName) {
            var templateEditor = document.getElementById('templateEditor');
            var cursorPos = templateEditor.selectionStart;
            var textBefore = templateEditor.value.substring(0, cursorPos);
            var textAfter = templateEditor.value.substring(cursorPos);
            
            templateEditor.value = textBefore + '{{' + columnName + '}}' + textAfter;
            templateEditor.focus();
            
            var newCursorPos = cursorPos + columnName.length + 4;
            templateEditor.setSelectionRange(newCursorPos, newCursorPos);
        }
        
        function populateDefaultTemplate(headers) {
            var templateEditor = document.getElementById('templateEditor');
            
            var template = '';
            var nameField = findHeader(headers, 'name');
            var jobField = findHeader(headers, 'job') || findHeader(headers, 'title');
            var companyField = findHeader(headers, 'company') || findHeader(headers, 'organization');
            
            if (nameField) template += 'Name: {{' + nameField + '}}\n';
            if (jobField) template += 'Job: {{' + jobField + '}}\n';
            if (companyField) template += 'Company: {{' + companyField + '}}\n\n';
            
            template += 'Profile:\n';
            
            var bioField = findHeader(headers, 'about') || findHeader(headers, 'bio') || findHeader(headers, 'family') || findHeader(headers, 'profile');
            
            if (bioField) template += '{{' + bioField + '}}\n\n';
            
            template += 'Contact:\n';
            var emailField = findHeader(headers, 'email');
            if (emailField) template += 'Email: {{' + emailField + '}}\n';
            
            for (var i = 0; i < headers.length; i++) {
                var header = headers[i];
                if (header !== nameField && header !== jobField && header !== companyField && header !== bioField && header !== emailField) {
                    template += '\n{{' + header + '}}\n';
                }
            }
            
            template += '\n---\n\n';
            templateEditor.value = template;
        }
        
        function findHeader(headers, searchTerm) {
            for (var i = 0; i < headers.length; i++) {
                if (headers[i].toLowerCase().indexOf(searchTerm) !== -1) {
                    return headers[i];
                }
            }
            return null;
        }
        
        function generateTextFile() {
            updateProgress(3);
            var template = document.getElementById('templateEditor').value;
            var preview = document.getElementById('textPreview');
            
            var allText = '';
            for (var i = 0; i < csvData.data.length; i++) {
                var row = csvData.data[i];
                var processedText = processTemplate(template, row);
                allText += processedText;
                if (i < csvData.data.length - 1) {
                    allText += '\n\n';
                }
            }
            
            preview.textContent = allText;
            
            var downloadBtn = document.getElementById('downloadTextBtn');
            downloadBtn.disabled = false;
            downloadBtn.onclick = function() {
                var blob = new Blob([allText], { type: 'text/plain' });
                var a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'survey_content.txt';
                a.click();
                URL.revokeObjectURL(a.href);
            };
        }
        
        function processTemplate(template, data) {
            var result = template;
            var regex = /\{\{([^}]+)\}\}/g;
            var match;
            
            while ((match = regex.exec(template)) !== null) {
                var placeholder = match[0];
                var columnName = match[1].trim();
                
                if (data[columnName] !== undefined) {
                    var escaped = escapeRegExp(placeholder);
                    var replaceRegex = new RegExp(escaped, 'g');
                    result = result.replace(replaceRegex, data[columnName]);
                }
            }
            
            return result;
        }
        
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
        
        function setupTextToCsvWorkflow() {
            var parseBtn = document.getElementById('parseTextBtn');
            parseBtn.onclick = parseTextToCSV;
        }
        
        function parseTextToCSV() {
            updateProgress(3);
            var separator = document.getElementById('recordSeparator').value;
            var marker = document.getElementById('fieldMarker').value;
            var fieldNamesText = document.getElementById('fieldNames').value;
            var fieldNames = fieldNamesText.split('\n').filter(function(n) { 
                return n.trim(); 
            });
            
            if (!separator || !marker || !fieldNames.length) {
                alert('Please fill in all configuration fields.');
                return;
            }
            
            if (marker.indexOf('FIELD') === -1) {
                alert('Field marker must include "FIELD"');
                return;
            }
            
            var records = textContent.split(separator);
            var csvRows = [];
            var recordsWithMissingData = 0;
            
            for (var i = 0; i < records.length; i++) {
                var record = records[i];
                if (record.trim()) {
                    var row = {};
                    var recordHasMissingData = false;
                    
                    // Find all field markers and their positions
                    var markers = [];
                    for (var j = 0; j < fieldNames.length; j++) {
                        var fieldName = fieldNames[j];
                        var pattern = marker.replace('FIELD', fieldName);
                        var escapedPattern = pattern.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                        var regex = new RegExp(escapedPattern, 'g');
                        var match;
                        
                        while ((match = regex.exec(record)) !== null) {
                            markers.push({
                                fieldName: fieldName,
                                start: match.index + pattern.length,
                                markerStart: match.index
                            });
                        }
                    }
                    
                    // Sort markers by position
                    markers.sort(function(a, b) { return a.start - b.start; });
                    
                    // Extract content between markers
                    for (var j = 0; j < markers.length; j++) {
                        var currentMarker = markers[j];
                        var endPos = (j + 1 < markers.length) ? markers[j + 1].markerStart : record.length;
                        row[currentMarker.fieldName] = record.substring(currentMarker.start, endPos).trim();
                    }
                    
                    // Check for missing fields
                    for (var j = 0; j < fieldNames.length; j++) {
                        if (!row.hasOwnProperty(fieldNames[j])) {
                            row[fieldNames[j]] = '';
                            recordHasMissingData = true;
                        } else if (row[fieldNames[j]] === '') {
                            recordHasMissingData = true;
                        }
                    }
                    
                    if (recordHasMissingData) {
                        recordsWithMissingData++;
                    }
                    
                    csvRows.push(row);
                }
            }
            
            // Show results
            document.getElementById('csvPreviewPlaceholder').style.display = 'none';
            document.getElementById('tableContainer').style.display = 'block';
            
            var info = document.getElementById('csvPreviewInfo');
            info.classList.remove('hidden');
            var infoText = '<strong>Found ' + csvRows.length + ' records with ' + fieldNames.length + ' columns</strong>';
            if (recordsWithMissingData > 0) {
                infoText += ' | <strong style="color: #dc2626;">' + recordsWithMissingData + ' record' + (recordsWithMissingData === 1 ? ' has' : 's have') + ' missing data</strong>';
            }
            info.innerHTML = infoText;
            
            var header = document.getElementById('csvTableHeader');
            header.innerHTML = '';
            for (var i = 0; i < fieldNames.length; i++) {
                var th = document.createElement('th');
                th.textContent = fieldNames[i];
                header.appendChild(th);
            }
            
            var tbody = document.getElementById('csvTableBody');
            tbody.innerHTML = '';
            for (var i = 0; i < csvRows.length; i++) {
                var row = csvRows[i];
                var tr = document.createElement('tr');
                
                for (var j = 0; j < fieldNames.length; j++) {
                    var field = fieldNames[j];
                    var td = document.createElement('td');
                    td.textContent = row[field] || '';
                    
                    if (!row[field]) {
                        td.classList.add('missing-data');
                    }
                    
                    tr.appendChild(td);
                }
                tbody.appendChild(tr);
            }
            
            var csvText = '';
            for (var i = 0; i < fieldNames.length; i++) {
                csvText += '"' + fieldNames[i] + '"';
                if (i < fieldNames.length - 1) csvText += ',';
            }
            csvText += '\n';
            
            for (var i = 0; i < csvRows.length; i++) {
                var row = csvRows[i];
                for (var j = 0; j < fieldNames.length; j++) {
                    var field = fieldNames[j];
                    var value = (row[field] || '').replace(/"/g, '""');
                    csvText += '"' + value + '"';
                    if (j < fieldNames.length - 1) csvText += ',';
                }
                csvText += '\n';
            }
            
            var downloadBtn = document.getElementById('downloadCsvBtn');
            downloadBtn.disabled = false;
            downloadBtn.onclick = function() {
                var BOM = '\uFEFF';
                var blob = new Blob([BOM + csvText], { type: 'text/csv;charset=utf-8;' });
                var a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'survey_data.csv';
                a.click();
                URL.revokeObjectURL(a.href);
            };
        }
        
        // Initialize
        updateProgress(1);
    </script>
</body>
</html>
